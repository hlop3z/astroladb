<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Alab GraphQL Explorer</title>
    <link rel="icon" type="image/png" href="/logo.png" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/graphiql@3/graphiql.min.css"
    />
    <script type="importmap">
      { "imports": { "graphql": "https://esm.sh/graphql@16?bundle" } }
    </script>
  </head>
  <body style="margin: 0">
    <div id="graphiql" style="height: 100vh"></div>

    <!-- React & GraphiQL UMD builds -->
    <script
      src="https://unpkg.com/react@18/umd/react.production.min.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/graphiql@3/graphiql.min.js"
      crossorigin
    ></script>

    <script type="module">
      import { buildSchema, graphql } from "graphql";

      async function init() {
        // Load SDL and example data
        const [sdl, examples] = await Promise.all([
          fetch("/graphql").then((r) => r.text()),
          fetch("/graphql/examples").then((r) => r.json()),
        ]);

        const schema = buildSchema(sdl);

        // Root resolver: return example values
        const rootValue = {};
        for (const [key, value] of Object.entries(examples)) {
          rootValue[key] = () => value;
        }

        // GraphiQL fetcher
        const fetcher = async (params) => {
          return graphql({
            schema,
            source: params.query,
            variableValues: params.variables || {},
            rootValue,
          });
        };

        // Render GraphiQL
        const root = ReactDOM.createRoot(document.getElementById("graphiql"));
        root.render(
          React.createElement(GraphiQL, {
            fetcher,
            defaultQuery: `# Alab GraphQL Schema Explorer
#
# This is a local mock server with example data.
# Use the Docs panel (top-right) to browse types.
#
`,
          })
        );

        // Optional hot reload: reload on server push
        if (typeof EventSource !== "undefined") {
          try {
            const evtSource = new EventSource("/_reload");
            evtSource.onmessage = () => location.reload();
          } catch (err) {
            console.warn("Live reload unavailable:", err);
          }
        }
      }

      // Initialize
      init();
    </script>
  </body>
</html>
